<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kelola Produk</title>
    <link href="./../../../../dist/styles.css" rel="stylesheet" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/your-kit-id.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div class="container">
      <h1>Kelola Produk</h1>
      <button id="addProductBtn">Tambah Produk</button>
      <div id="productList" class="product-list"></div>
    </div>

    <!-- Modal -->
    <div id="productModal" class="modal">
      <div class="modal-content">
        <h2 id="modalTitle">Tambah Produk</h2>
        <form id="productForm">
          <input type="hidden" id="productId" />
          <label>Nama Produk:</label>
          <input type="text" id="productName" required /><br /><br />
          <label>Deskripsi:</label>
          <textarea id="productDescription" required></textarea><br /><br />
          <label>Harga:</label>
          <input type="number" id="productPrice" required /><br /><br />
          <label>Stok:</label>
          <input type="number" id="productStock" required /><br /><br />
          <label>Gambar:</label>
          <input type="file" id="productImage" /><br /><br />
          <button type="submit">Simpan</button>
          <button type="button" id="closeModal">Batal</button>
        </form>
      </div>
    </div>

    <script>
      const productList = document.getElementById("productList");
      const productModal = document.getElementById("productModal");
      const productForm = document.getElementById("productForm");
      const addProductBtn = document.getElementById("addProductBtn");
      const closeModal = document.getElementById("closeModal");
      const modalTitle = document.getElementById("modalTitle");
      const token = localStorage.getItem("token");

      // API Base URL
      const BASE_URL = "https://backend-eight-phi-75.vercel.app/api/produk";

      // Fetch Produk
      async function fetchProducts() {
        try {
          const response = await fetch(`${BASE_URL}/all`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) throw new Error("Gagal memuat produk");
          const products = await response.json();
          renderProducts(products);
        } catch (error) {
          console.error(error);
        }
      }

      // Render Produk
      function renderProducts(products) {
        productList.innerHTML = "";
        products.forEach((product) => {
          const productCard = document.createElement("div");
          productCard.className = "product-card";
          productCard.innerHTML = `
              <img src="https://storage.supabase.io/gambar/${product.gambar}" alt="${product.nama}">
              <h3>${product.nama}</h3>
              <p>${product.deskripsi}</p>
              <p>Harga: Rp${product.harga}</p>
              <p>Stok: ${product.qty}</p>
              <button onclick="editProduct(${product.id})">Edit</button>
              <button onclick="deleteProduct(${product.id})">Hapus</button>
            `;
          productList.appendChild(productCard);
        });
      }

      // Tambah/Edit Produk
      productForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("productId").value;
        const formData = new FormData();
        formData.append("nama", document.getElementById("productName").value);
        formData.append(
          "deskripsi",
          document.getElementById("productDescription").value
        );
        formData.append("harga", document.getElementById("productPrice").value);
        formData.append("qty", document.getElementById("productStock").value);
        if (document.getElementById("productImage").files[0]) {
          formData.append(
            "file",
            document.getElementById("productImage").files[0]
          );
        }

        try {
          const response = await fetch(
            id ? `${BASE_URL}/update/${id}` : `${BASE_URL}/create`,
            {
              method: id ? "PUT" : "POST",
              headers: { Authorization: `Bearer ${token}` },
              body: formData,
            }
          );
          if (!response.ok) throw new Error("Gagal menyimpan produk");
          alert("Produk berhasil disimpan");
          closeModal.click();
          fetchProducts();
        } catch (error) {
          console.error(error);
        }
      });

      // Hapus Produk
      async function deleteProduct(id) {
        if (!confirm("Yakin ingin menghapus produk ini?")) return;
        try {
          const response = await fetch(`${BASE_URL}/delete/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) throw new Error("Gagal menghapus produk");
          alert("Produk berhasil dihapus");
          fetchProducts();
        } catch (error) {
          console.error(error);
        }
      }

      // Edit Produk
      async function editProduct(id) {
        try {
          const response = await fetch(`${BASE_URL}/${id}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) throw new Error("Gagal memuat produk");
          const product = await response.json();
          document.getElementById("productId").value = product.id;
          document.getElementById("productName").value = product.nama;
          document.getElementById("productDescription").value =
            product.deskripsi;
          document.getElementById("productPrice").value = product.harga;
          document.getElementById("productStock").value = product.qty;
          modalTitle.textContent = "Edit Produk";
          productModal.style.display = "flex";
        } catch (error) {
          console.error(error);
        }
      }

      // Event Listeners
      addProductBtn.addEventListener("click", () => {
        document.getElementById("productForm").reset();
        document.getElementById("productId").value = "";
        modalTitle.textContent = "Tambah Produk";
        productModal.style.display = "flex";
      });
      closeModal.addEventListener("click", () => {
        productModal.style.display = "none";
      });

      // Inisialisasi
      fetchProducts();
    </script>
  </body>
</html>
